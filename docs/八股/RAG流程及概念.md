---
sidebar_position: 1
---

RAG基本流程分为数据准备、索引构建（embedding）、检索优化、生成四个部分。  

## 索引构建

向量数据库可以高效处理大量高维向量。（相似性搜索、存储能力、查询能力、与模型生态，主流AI框架集成）    

向量数据库与传统数据库差异：  

|维度|向量数据库|传统数据库|
|:-:|:-:|:-:|
|核心数据类型|高维向量|结构化数据（每个数据有固定属性，如日期、数字等）|
|查询方式|ANN|精确匹配|
|索引机制|ANN索引，如HNSW、IVF、LSH|B-Tree, Hash Index|
|性能特点|高维数据检索性能极高，计算密集型|结构化数据查询快，高维数据查询性能呈指数级下降|
|一致性|最终一致性|强一致性|

不同向量数据库的索引类型：  
ToDo

向量数据库通常采用四层架构，为存储层、索引层、查询层、服务层。其中索引是一种为了加速查询而设计的复杂数据结构，会占用额外的内存。  

索引组件包括数据结构、量化（数据压缩，降低精度减少内存、加速计算）和结果精炼（找到初步候选集后，精确计算得到最终结果）。

主流数据库类型：  
ToDo

索引创建这一过程（在源码中）共分为四步：  

1. 从``Document``对象中提取文本内容和元数据。  
2. 将文本转化为向量，将向量和元数据一起传给下一步的函数。  
3. 初始化对应（例如FAISS）的索引结构。
4. 将向量添加到索引中；将文本和元数据打包储存；建立FAISS内部ID到文档ID的映射关系。  

在索引构建时，使用小块文本进行检索可以获得更高的精确度，但小块文本缺乏足够的上下文，可能导致大语言模型（LLM）无法生成高质量的答案；而使用大块文本虽然上下文丰富，却容易引入噪音，降低检索的相关性。为解决这一问题引入了句子窗口检索（Sentence Window Retrieval），检索时聚焦句子，生成答案前扩展回窗口。完整的句子和原句子都会作为元数据存储，不参与索引。  

此外，当一个查询可能只与其中一两个文档相关时，在整个文档库中进行无差别的向量搜索，不仅效率低下，还容易被不相关的文本块干扰，导致检索结果不精确。结构化索引可以先通过元数据预过滤，可以使用各个框架的结构化索引。此外，也可以为每个文档（集合）创建一个介绍性质的摘要，为所有摘要构建一个轻量级索引。

## 检索

### 向量检索

向量分为稀疏向量和密集向量两种。

稀疏向量维度极高（与词汇表大小相当），大多数元素为0。在这种情况下，每个维度都代表一个确切的词，无需训练可以实现精确匹配，但无法理解语义。  

*BM25、TF-IDF*  

密集向量也成为语义向量，在语义空间中，向量间的距离代表它们的关系（向量相加等于另一个向量），能够理解同义词、近义词和上下文关系，泛化能力强。但可解释性差，需要大量训练，对未登录词（OOV）处理困难。  

*Word2Vec、GloVe、基于Transformer的模型*  
*BPE、WordPiece*

对于稀疏向量的关键词检索可能无法理解语义，而对于密集向量的检索可能忽略需要精确匹配的关键词。混合检索执行两种算法，将结果融合成一个统一的排序列表。  

倒数排序融合（Reciprocal Rank Fusion，RRF）不关心两个系统给出的评分，只关心排名。文档的排名越靠前，得分就越高。积分公式为  

$$
RRF_{score}(d) = \Sigma_{i=1}^k 1/(rank_i(d) + c)
$$

其中d为待评分文档，k为检索系统数量，c为常数，降低排名靠后文档的权重。  

另一种方式是加权线性组合。这种方法需要先将各个系统的评分归一化。  

$$
Hybrid_{score} = \alpha \cdot Dense_{score} + (1 - \alpha) \cdot Sparse_{score}
$$

通过$\alpha$可以调整语义相似性与关键词匹配在最终排序中的贡献比例。  

混合检索的召回率、灵活性、容错性都更强，但参数调试复杂、资源消耗大，且排序理由难以直观分析。  

### 查询构建

需要通过LLM，将用户输入的自然语言转化为可理解的过滤信息、搜索信息等。  

